---
title: "Gene Program and Pathway Analysis"
editor: source
author: "Joe Boktor"
date: '2025-12-27'
format: 
  html:
    self-contained: true
    code-fold: true
    code-tools: true
    fig-align: right
    fig-height: 8
    fig-width: 14 
---


```{r}
library(Seurat)
library(Matrix)
library(irlba)
library(scico)
library(tidyverse)
library(patchwork)
library(glue)
library(presto)
library(hdf5r)
library(tidyseurat)
library(Augur)
library(batchtools)
library(gprofiler2)

library(tictoc)
library(future)
library(strex)
library(cowplot)
library(aplot)
library(SingleCellExperiment)
library(BiocParallel)
library(ggside)

theme_set(theme_bw())

home_dir <- "/resnick/groups/MazmanianLab/jboktor"
rnk_dir <- "/resnick/groups/mthomson/jboktor"
split_pipe_dir <- glue("{rnk_dir}/split-pipe_workflow")
wkdir <- glue("{home_dir}/WILDRxSPF_brains")
anndata_path <- glue("{wkdir}/data/input/parse_bio_anndata")
data_path <- glue("{wkdir}/data/interim")
fig_path <- glue("{wkdir}/figures")
abca_color_pal <- readRDS(glue("{wkdir}/data/interim/abca_color_pal.rds"))

source(glue("{wkdir}/notebooks/R_scripts/_misc_functions.R"))

# Set memory limit for future
options(future.globals.maxSize = 200000 * 1024^2)  # Set to ~200GB
# Use more memory-efficient serialization
options(future.serialization.progressr = FALSE)
options(future.serialization.progressr.enable = FALSE)

# future::plan(multisession, workers = 3)
# future::plan(sequential)

```


Loading Seurat object


```{r}
seurat_obj <- readRDS( 
    glue("{data_path}/seurat/snRNASeq/",
    "seurat_obj_onlyparsefilters_celltyped_2025-12-27.rds")
    )
seurat_obj
# Subset the seurat object to only keep cells that pass the QC filters
seurat_obj <- seurat_obj %>% subset(subset = keep_cell)
seurat_obj@meta.data %>% glimpse()

```



Loading significant MAST results

```{r}
# gene metadata
gene_meta <- seurat_obj[["RNA"]][[]] %>%
    mutate(primerid = gsub("_GRCm39", "-GRCm39", gene)) %>% 
    dplyr::select(primerid, gene_name, gene_id, gene_type) %>% 
    dplyr::glimpse()

class_mast_df <- readRDS(
  glue("{data_path}/mast/snRNASeq/class_mast_signif_hits_2025-12-29.rds")
  ) %>% 
  left_join(gene_meta, by = c("primerid")) %>% 
  mutate(cell_type = class_name, cell_type_label = "class_name") %>% 
  glimpse()
subclass_mast_df <- readRDS(
  glue("{data_path}/mast/snRNASeq/subclass_mast_signif_hits_2025-12-29.rds")
    ) %>% left_join(gene_meta, by = c("primerid")) %>% 
  mutate(cell_type = subclass_name, cell_type_label = "subclass_name") %>% 
  glimpse()
supertype_mast_df <- readRDS(
  glue("{data_path}/mast/snRNASeq/supertype_mast_signif_hits_2025-12-29.rds")
  ) %>% left_join(gene_meta, by = c("primerid")) %>% 
  mutate(cell_type = supertype_name, cell_type_label = "supertype_name") %>% 
  glimpse()


all_mast_df <- bind_rows(class_mast_df, subclass_mast_df, supertype_mast_df)
all_ndegs <- all_mast_df %>% 
    filter(p_adjust < 0.05) %>% 
    group_by(celltype_tissue) %>% 
    tally() %>% 
    arrange(desc(n)) %>% 
    glimpse()

```



```{r}
run_gprofiler <- function(genelist, output_path) {
    gostres <- gprofiler2::gost(
        query = genelist, organism = "mmusculus")
    saveRDS(gostres, output_path)
}


# MAST results with a p-value adjustment of < 0.05
class_mast_df %>% 
    dplyr::select(celltype_tissue, gene_id) %>% 
    group_by(celltype_tissue) %>% 
    nest() %>% 
    mutate(output_path = glue("{data_path}/gprofiler/snRNASeq/class_mast_df_{celltype_tissue}_{Sys.Date()}.rds")) %>% 
    pmap(run_gprofiler)

# tic()
# genels <- class_mast_df %>% 
#     filter(celltype_tissue == "CS20230722_CLAS_30_AMY") %>% 
#     pull(gene_id)
# gres <- gprofiler2::gost(query = genels, organism = "mmusculus")
# toc()


class_mast_df %>% 
    dplyr::select(celltype_tissue, gene_id) %>% 
    group_by(celltype_tissue) %>% 
    summarise(gene_id = list(gene_id), .groups = "drop") %>% 
    mutate(output_path = glue("{data_path}/gprofiler/snRNASeq/class_mast_df_{celltype_tissue}_{Sys.Date()}.rds")) %>% 
    pmap(run_gprofiler)


# # p <- 
# gostplot(gres, capped = FALSE, interactive = FALSE)

# supertype_mast_df %>% 

```
